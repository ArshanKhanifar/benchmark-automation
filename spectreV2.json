{
	"common_setup": [
    "rm -rf /usr/tmp.src; git clone https://github.com/freebsd/freebsd.git /usr/tmp.src",
    "rm -rf /usr/src; cp -r /usr/tmp.src/. /usr/src",
    "cd /usr/src; curl -k https://reviews.freebsd.org/file/data/5s4bhiczo3vjr3kubuxe/PHID-FILE-3d7ss2e4ednexzio6mtq/D14242.diff | git apply -p0"
	],
	"common_commands": [
		"if ! kldstat -n cpuctl -q; then kldload cpuctl; fi",
		"cpucontrol -e /dev/cpuctl10",

		"sysctl vm.pmap > output/pmap.log",
		"uname -a > output/uname.log",
		"kenv | grep \"^smbios\\.\" > output/kenv.log",
		"dmesg > output/dmesg.log",
		"x86info -a > output/x86info.log",
    "objdump -d <kernel> | egrep 'call|jmp.*\\*' > output/objdump.log",

		"mount -t tmpfs tmpfs /usr/src",
		"mount -t tmpfs tmpfs /usr/obj",
		"cp -r /usr/tmp.src/. /usr/src",

		"make -C /usr/src/tools/tools/syscall_timing",
		"make install -C /usr/src/tools/tools/syscall_timing",
		"/usr/obj/usr/src/amd64.amd64/tools/tools/syscall_timing/syscall_timing getppid > output/getppid.log",

		"for i in $(jot 3); do rm -rf /usr/obj/*; /usr/bin/time -o output/buildtime.$i.log sh -c \"make -C /usr/src -j$(sysctl -n hw.ncpu) buildworld > output/build.$i.log 2>&1\"; done"
	],
	"benchmarks": [
		{
			"name": "no-retpoline",
			"setup": [
        "rm -rf update-logs; mkdir update-logs",
        "make -C /usr/src KERNCONF=GENERIC-NODEBUG  -j$(sysctl -n hw.ncpu) buildkernel buildworld > update-logs/update-build.log 2>&1",
        "make -C /usr/src KERNCONF=GENERIC-NODEBUG installkernel installworld > update-logs/install-build.log 2>&1"
			],
			"needs_reboot": true
		},
		{
			"name": "with-retpoline",
			"setup": [
        "echo 'WITH_KERNEL_RETPOLINE=yes' > /usr/src/etc/src.conf", 
        "rm -rf update-logs1; mkdir update-logs1",
        "make -C /usr/src KERNCONF=GENERIC-NODEBUG  -j$(sysctl -n hw.ncpu) buildkernel buildworld > update-logs1/update-build.log 2>&1",
        "make -C /usr/src KERNCONF=GENERIC-NODEBUG installkernel installworld > update-logs1/install-build.log 2>&1"
			],
			"commands": [
			],
			"needs_reboot": true
		}
  ]
}

